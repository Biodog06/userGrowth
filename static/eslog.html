<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ES æ—¥å¿—ç›‘æ§ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { background-color: #f5f7fa; margin: 0; padding: 20px; font-family: "Helvetica Neue",Helvetica,Arial,sans-serif; }
        .filter-card { margin-bottom: 20px; }
        .log-table { border-radius: 8px; overflow: hidden; }
        .level-tag { width: 60px; text-align: center; }
        .pagination-container { margin-top: 20px; display: flex; justify-content: flex-end; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    </style>
</head>
<body>
<div id="app">
    <div class="header">
        <h2 style="margin: 0; color: #409EFF;">ğŸš€ ES æ—¥å¿—ç›‘æ§é¢æ¿</h2>
        <el-button type="danger" plain @click="handleLogout">é€€å‡ºç™»å½•</el-button>
    </div>

    <!-- è¿‡æ»¤å™¨å¡ç‰‡ -->
    <el-card class="filter-card" shadow="never">
        <el-form :inline="true" :model="queryParam">
            <el-form-item label="å…³é”®è¯">
                <el-input v-model="queryParam.keyword" placeholder="æœç´¢æ¶ˆæ¯å†…å®¹" clearable @keyup.enter="handleSearch"></el-input>
            </el-form-item>
            <el-form-item label="çº§åˆ«">
                <el-select v-model="queryParam.level" placeholder="å…¨éƒ¨çº§åˆ«" clearable style="width: 120px;">
                    <el-option label="INFO" value="info"></el-option>
                    <el-option label="WARN" value="warn"></el-option>
                    <el-option label="ERROR" value="error"></el-option>
                    <el-option label="DEBUG" value="debug"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="æ—¶é—´èŒƒå›´">
                <el-date-picker
                        v-model="dateRange"
                        type="datetimerange"
                        range-separator="è‡³"
                        start-placeholder="å¼€å§‹æ—¶é—´"
                        end-placeholder="ç»“æŸæ—¶é—´"
                        value-format="YYYY-MM-DDTHH:mm:ssZ"
                ></el-date-picker>
            </el-form-item>
            <el-form-item>
                <el-button type="primary" @click="handleSearch">æŸ¥è¯¢</el-button>
                <el-button @click="resetQuery">é‡ç½®</el-button>
            </el-form-item>
        </el-form>
    </el-card>

    <!-- æ—¥å¿—è¡¨æ ¼ -->
    <el-table :data="logData" v-loading="loading" class="log-table" stripe style="width: 100%" border>
        <!-- ä¿®æ”¹ æ—¶é—´åˆ— -->
        <el-table-column label="æ—¶é—´" width="220">
            <template #default="scope">
                <!-- å°è¯• ts, timestamp, @timestamp, T ç­‰å¸¸è§å­—æ®µ -->
                {{ formatTime(scope.row.ts || scope.row.timestamp || scope.row['@timestamp'] || scope.row.T) }}
            </template>
        </el-table-column>

        <!-- ä¿®æ”¹ å†…å®¹åˆ— -->
        <el-table-column label="æ—¥å¿—å†…å®¹" min-width="400">
            <template #default="scope">
                <!-- å°è¯• message, msg, content ç­‰å¸¸è§å­—æ®µ -->
                <code style="word-break: break-all;">
                    {{ scope.row.message || scope.row.msg || scope.row.content || JSON.stringify(scope.row) }}
                </code>
            </template>
        </el-table-column>
        <el-table-column prop="caller" label="è°ƒç”¨è€…" width="200" show-overflow-tooltip></el-table-column>
    </el-table>

    <!-- åˆ†é¡µ -->
    <div class="pagination-container">
        <el-pagination
                v-model:current-page="queryParam.page"
                v-model:page-size="queryParam.size"
                :page-sizes="[10, 20, 50, 100]"
                layout="total, sizes, prev, pager, next, jumper"
                :total="total"
                @size-change="fetchLogs"
                @current-change="fetchLogs"
        ></el-pagination>
    </div>
</div>

<script>
    const { createApp, ref, reactive, onMounted } = Vue;

    createApp({
        setup() {
            const loading = ref(false);
            const logData = ref([]);
            const total = ref(0);
            const dateRange = ref([]);

            const queryParam = reactive({
                keyword: '',
                level: '',
                start_time: '',
                end_time: '',
                page: 1,
                size: 10
            });

            // è·å–æ—¥å¿—æ•°æ®
            const fetchLogs = async () => {
                loading.value = true;
                try {
                    // å¤„ç†æ—¶é—´èŒƒå›´
                    if (dateRange.value && dateRange.value.length === 2) {
                        queryParam.start_time = dateRange.value[0];
                        queryParam.end_time = dateRange.value[1];
                    } else {
                        queryParam.start_time = '';
                        queryParam.end_time = '';
                    }

                    // å‘é€ GET è¯·æ±‚ï¼Œå‚æ•°ç»‘å®šåˆ° URL Query ä¸Š
                    const res = await axios.get('/api/eslog', { params: queryParam });

                    if (res.data.code === 200) {
                        logData.value = res.data.data;
                        total.value = res.data.total;
                    }
                } catch (err) {
                    console.error(err);
                    ElementPlus.ElMessage.error('è·å–æ—¥å¿—å¤±è´¥: ' + (err.response?.data?.error || 'æœåŠ¡å™¨é”™è¯¯'));
                } finally {
                    loading.value = false;
                }
            };

            const handleSearch = () => {
                queryParam.page = 1;
                fetchLogs();
            };

            const resetQuery = () => {
                queryParam.keyword = '';
                queryParam.level = '';
                queryParam.page = 1;
                dateRange.value = [];
                fetchLogs();
            };

            const getLevelType = (level) => {
                const l = level.toLowerCase();
                if (l.includes('info')) return 'info';
                if (l.includes('warn')) return 'warning';
                if (l.includes('error')) return 'danger';
                if (l.includes('debug')) return 'success';
                return '';
            };

            const formatTime = (ts) => {
                if (!ts) return '-';
                return new Date(ts).toLocaleString();
            };

            const handleLogout = () => {
                window.location.href = '/login.html';
            };

            onMounted(() => {
                fetchLogs();
            });

            return {
                loading, logData, total, queryParam, dateRange,
                fetchLogs, handleSearch, resetQuery, getLevelType, formatTime, handleLogout
            };
        }
    }).use(ElementPlus).mount('#app');
</script>
</body>
</html>